import{bN as b,bI as h,aA as y,bO as p,bP as E,af as f}from"./chunk-Bg4HykUt.js";function m(s){return new Promise(r=>{setTimeout(r,s)})}const O=b(s=>{let r="系统错误";if(s instanceof Error){if(s.name==="AbortError"&&s.message.includes("user"))return;r={"Failed to fetch":"请求失败","The user aborted a request.":"请求被终止"}[s.message]||s.message}if(typeof s=="string"&&(r=s),h(s)){const a=s?.msg||s?.message;a&&(r=a)}y({type:"error",message:r})},500,{trailing:!1}),P=s=>s.code===200||s.status===10001;function T(s,r){const a=r?.onerror||O,i=r?.customOk||P,d=async(n,g)=>{const{state:l,res:o}=n,e={loading:!0,loadingDelay:400,loadingClose:!0,...l,error:l.error??!0,onerror:l.onerror??a},w=e.loading;let u=null;await g();const c=o.when();if(w){const t=p.service||E;await Promise.race([m(e.loadingDelay),c])||(f(e.loading)?e.loading.value=!0:u=t(typeof e.loading=="boolean"?{}:e.loading))}e.loadingClose&&c.finally(()=>{u?.close(),f(e.loading)&&(e.loading.value=!1)}),e.error&&c.catch(t=>{throw e.error&&e.onerror(t),t}),await c.then(t=>{i(t)?e.successMessage&&y({type:"success",message:typeof e.successMessage=="string"?e.successMessage:t.msg||t.message||"请求成功"}):(e.error&&e.onerror(t),e.throwResErr&&(n.body=Promise.reject(t)))})};s.addMiddleware(d)}function q(s,r){const a=async(i,d)=>{const{state:n,req:{requestOptions:g,requestInit:l}}=i,o={retryTimes:3,retryDelay:4e3,retryEnable:!0,...r,...n};await d();async function e(){o.retryEnable&&o.retryTimes>0&&(await m(o.retryDelay),i.body=await s.request(g,{...n,retryTimes:--o.retryTimes},l))}i.body instanceof Promise?await i.body.catch(e):o.retryWhen&&o.retryWhen(i.body)&&await e()};s.addMiddleware(a)}export{T as E,q as R};
